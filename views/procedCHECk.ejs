<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.2/mdb.rtl.min.css">
    <link rel="icon" type="image/x-icon" href="/images/logo-header-regular.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>

<body>

    <%- include('partials/__homeheader__') %>
        <header
            class="site-header header-main-layout-1 ast-primary-menu-enabled ast-logo-title-inline ast-hide-custom-menu-mobile ast-builder-menu-toggle-icon ast-mobile-header-inline"
            id="masthead" itemscope="itemscope" itemid="#masthead">
            <div id="ast-desktop-header" data-toggle-type="dropdown">
                <div class="ast-main-header-wrap main-header-bar-wrap ">
                    <div class="ast-primary-header-bar ast-primary-header main-header-bar site-header-focus-item"
                        data-section="section-primary-header-builder">
                        <div class="site-primary-header-wrap ast-builder-grid-row-container site-header-focus-item ast-container"
                            data-section="section-primary-header-builder">
                            <div class="ast-builder-grid-row ast-builder-grid-row-has-sides ast-grid-center-col-layout">
                                <div
                                    class="site-header-primary-section-left site-header-section ast-flex site-header-section-left">
                                    <div class="ast-builder-menu-1 ast-builder-menu ast-flex ast-builder-menu-1-focus-item ast-builder-layout-element site-header-focus-item"
                                        data-section="section-hb-menu-1">
                                        <div class="ast-main-header-bar-alignment">
                                            <div class="main-header-bar-navigation">
                                                <nav class="site-navigation ast-flex-grow-1 navigation-accessibility site-header-focus-item"
                                                    id="primary-site-navigation-desktop" aria-label="Site Navigation"
                                                    itemscope="itemscope">
                                                    <div class="main-navigation ast-inline-flex">
                                                        <ul id="ast-hf-menu-1"
                                                            class="main-header-menu ast-menu-shadow ast-nav-menu ast-flex  submenu-with-border ast-menu-hover-style-underline  stack-on-mobile">
                                                            <li id="menu-item-81"
                                                                class="menu-item menu-item-type-post_type menu-item-object-page menu-item-home menu-item-81">
                                                                <a href="/" class="menu-link">Home</a>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </nav>
                                            </div>
                                        </div>
                                    </div>
                                    <div
                                        class="site-header-primary-section-left-center site-header-section ast-flex ast-grid-left-center-section">
                                    </div>
                                </div>
                                <div
                                    class="site-header-primary-section-center site-header-section ast-flex ast-grid-section-center">
                                    <div class="ast-builder-layout-element ast-flex site-header-focus-item"
                                        data-section="title_tagline">
                                        <div class="site-branding ast-site-identity" itemscope="itemscope">
                                            <span class="site-logo-img"><a href="/" class="custom-logo-link"
                                                    rel="home"><img width="134" height="56"
                                                        src="/images/logo-header-regular copy.png" class="custom-logo"
                                                        alt="Eyewear Store"></a><span>
                                        </div>
                                    </div>
                                </div>
                                <div
                                    class="site-header-primary-section-right site-header-section ast-flex ast-grid-right-section">
                                    <div
                                        class="site-header-primary-section-right-center site-header-section ast-flex ast-grid-right-center-section">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </header>
        <!--Main layout-->
        <main class="pt-4">
            <div class="container">
                <!-- Heading -->
                <h2 style="margin-bottom: 20px;" class="text-center">Checkout Details</h2>
                <hr style="background-color: #1a0000;
                border: 0;
                height: 2px;
                margin-bottom: 1.5em;">
                <!-- <form action="/getAdd" method="post"> -->

                <!--------------------------------------------- CHECK OUT FORM--------------------------- -->
                <form action="" id="checkout-form">
                    <!--Grid row-->
                    <div class="row">
                        <!--Grid column-->
                        <div class="col-md-8 mb-4">
                            <!--Card-->
                            <div class="card p-4" style="margin-right: 100px; box-shadow: 6px 4px 21px #cdc4c4">
                                <!-- first data -->
                                <h5>CUSTOMER INFORMATION</h5>
                                <label>Email Address</label>
                                <div class="input-group mb-4">
                                    <h6>
                                        <%= emailData.email %>
                                    </h6>
                                </div>
                                <!-- first data -->
                                <h5>BILLING DETAILS</h5>
                                <hr>
                                <a href="/settings/addrs/n1" style="color: #d20202;
                                text-transform: capitalize;
                                margin-left: 36rem;">add new address</a>
                                <div class="row mb-3">
                                    <!--Grid column-->
                                    <h6>Select the Address</h4>
                                        <select class="browser-default custom-select mb-3"
                                            style="-webkit-appearance: none;-moz-appearance:none;appearance:none;" 
                                            name="address">
                                            <option>select address</option>
                                            <% for( let i=0; i < address.length; i++ ) { %>
                                                <option value="<%= address[i]._id %>">
                                                    <%= address[i].name %>
                                                        <%= address[i].address %>
                                                            <%= address[i].state %>
                                                                <%= address[i].city %>
                                                </option>
                                                <% } %>
                                        </select>
                                </div>


                            </div>
                            <div class="form-outline mb-4">
                                <hr />
                                <h4 class="my-4">PAYMENT</h4>

                                <p style="color: black;
                                background-color: antiquewhite;
                                margin-right: 40rem;
                                padding: 10px;
                                border-radius: 9px;
                                font-weight: 700;
                            ">Wallet Balance : $<%= walletData.wallet.balance %>
                                </p>
                                <div class="my-3" style="box-shadow: 3px 6px 26px #ffc4c4;
                                padding: 20px;
                                margin-right: 459px;
                                border-radius: 13px;">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="paymentmethod"
                                            id="flexRadioDefault1" checked value="Card" />
                                        <label class="form-check-label" for="flexRadioDefault1"> Net Banking </label>
                                    </div>
                                    <% if (walletData.wallet.balance> sumP) { %>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="paymentmethod"
                                                id="flexRadioDefault3" value="Wallet" />
                                            <label class="form-check-label" for="flexRadioDefault3"> Wallet</label>
                                        </div>
                                        <% } %>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="paymentmethod"
                                                    id="flexRadioDefault3" value="COD" />
                                                <label class="form-check-label" for="flexRadioDefault3"> COD </label>
                                            </div>
                                </div>
                                <hr class="mb-4" />

                                <input type="text" hidden name="totalamount" value="<%= sumP %>">
                                <input type="text" hidden name="coupenid" id="coupenid">
                                <!-- <button class="btn btn-primary" type="button">Continue to checkout</button> -->
                                <button type="submit" class="button alt" name="totalamount" id="placeholder"
                                    value="<%= sumP %>">Place
                                    Order $<span id="placeholderValue">
                                        <%= sumP %>
                                    </span>.00</button>
                            </div>
                            <!--/.Card-->
                        </div>
                        <!--Grid column-->
                </form>
                <!--Grid column-->
                <div class="col-md-4 mb-4">
                    <!-- Heading -->
                    <h4 class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted">Your cart</span>
                        <span class="badge rounded-pill badge-primary">
                            <%= count %>
                        </span>
                    </h4>

                    <!-- Cart -->
                    <ul class="list-group mb-3" style="margin: 0 -20px;">
                        <li class="list-group-item d-flex justify-content-between">
                            <div>
                                <h6 class="my-0">Product name</h6>
                            </div>
                            <span class="text-muted">Total</span>
                        </li>
                        <% for( let i=0; i < ProcsData.length; i++ ) { %>
                            <li class="list-group-item d-flex justify-content-between">
                                <div>
                                    <h6 class="my-0">
                                        <%= ProcsData[i].product_id.name %> x <%= ProcsData[i].qty %>
                                    </h6>
                                </div>
                                <span class="text-muted">$<%= ProcsData[i].totalPrice %></span>
                            </li>
                            <% } %>
                                <li class="list-group-item d-flex justify-content-between bg-light">
                                    <div class="text-success">
                                        <h6 class="my-0">Promo code</h6>
                                    </div>
                                    <span class="text-success" id="discountamountMinus">$0</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>Total (USD)</span>
                                    <strong id="totalcoupenamount">$<%= sumP %></strong>
                                </li>
                    </ul>
                    <!-- Cart -->

                    <!-- Promo code -->
                    <form class="card p-2">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" placeholder="Promo code" id="coupenname"
                                style="text-transform: uppercase;" aria-label="Promo code"
                                aria-describedby="button-addon2" />
                            <button class="btn btn-primary" type="button" id="button-addon2"
                                data-mdb-ripple-color="dark" onclick="coupenApply()">
                                redeem
                            </button>
                        </div>
                    </form>
                    <!-- Promo code -->
                </div>
                <!--Grid column-->
            </div>
            <!--Grid row-->
            </div>
        </main>
        <!--Main layout-->

        <!-- footer -->
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.2/mdb.min.js"></script>
        <script>
            $("#checkout-form").submit((e) => {
                e.preventDefault()
                $.ajax({
                    url: '/getAdd',
                    method: 'post',
                    data: $('#checkout-form').serialize(),
                    success: (response) => {
                        if (response.productDataNotFound) {
                            Swal.fire("Product not found!");
                        } else if (response.quantityExceeded) {
                            Swal.fire("Quantity for product exceeds !");
                        } else if (response.codSuccuss) {
                            // location.href = '/ordersuccess'
                            Swal.fire({
                                title: 'Order Placed Successfully',
                                html: `
                                <p>Thank you for your purchase! Now we're preparing for the shipment!...</p>
                                <a href="/settings/orders" class="btn btn-primary">Order Details</a>
                                <a href="/" class="btn btn-secondary">Home</a> `,
                                didOpen: () => {
                                    Swal.showLoading();
                                },
                                width: '40%',
                            })
                        } else if (response.walletSuccuss) {
                            // location.href = '/ordersuccess'
                            Swal.fire({
                                title: 'Order Placed Successfully',
                                html: `
                                <p>Thank you for your purchase! Now we're preparing for the shipment!...</p>
                                <a href="/settings/orders" class="btn btn-primary">Order Details</a>
                                <a href="/" class="btn btn-secondary">Home</a> `,
                                didOpen: () => {
                                    Swal.showLoading();
                                },
                                width: '40%',
                            })
                        } else {
                            razorpayPayment(response)
                        }
                    }
                })
            })
            function razorpayPayment(order) {
                var options = {
                    "key": "rzp_test_w6dIwCMt6fH2NS", // Enter the Key ID generated from the Dashboard
                    "amount": "<%= sumP %>", // < % = sumP % > Amount is in curre. Default currency is INR. Hence, 50000 refers to 50000 paise
                    "currency": "INR",
                    "name": "ReccardoEyeWear", //your business name
                    "description": "Test Transaction",
                    "image": "",
                    "order_id": order.razorpay_order_id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                    "handler": function (response) {
                        // window.location = '/ordersuccess'
                        verifyPayment(response, order)
                    },
                    "prefill": { //We recommend using the prefill parameter to auto-fill customer's contact information, especially their phone number
                        "name": "", //your customer's name
                        "email": "",
                        "contact": "9000090000"  //Provide the customer's phone number for better conversion rates 
                    },
                    "notes": {
                        "address": "Razorpay Corporate Office"
                    },
                    "theme": {
                        "color": "#3399cc"
                    }
                };
                var rzp = new Razorpay(options);
                rzp.open();
            }

            function verifyPayment(payment, order) {
                $.ajax({
                    url: '/verify-payment',
                    data: {
                        payment,
                        order
                    },
                    method: 'post',
                    success: (response) => {
                        if (response.razorpaySuccess == true) {
                            Swal.fire({
                                title: 'Order Placed Successfully',
                                html: `
                                <p>Thank you for your purchase! Now we're preparing for the shipment!...</p>
                                <a href="/settings/orders" class="btn btn-primary">Order Details</a>
                                <a href="/" class="btn btn-secondary">Home</a> `,
                                didOpen: () => {
                                    Swal.showLoading();
                                },
                                width: '40%',
                            })
                        } else {
                            swal.fire({
                                positon: "center",
                                icon: "error",
                                title: "Payment failed",
                                showConfirmButton: false,
                                timer: 1500,
                            })
                        }
                    }
                })
            }
        </script>

        <script>
            function coupenApply() {
                let coupencode = document.getElementById('coupenname').value;
                let totalamount = document.getElementById('totalcoupenamount').innerHTML;
                var data = totalamount.split('$')
                var datas = (data[1]);
                $.ajax({
                    url: '/coupenCheck',
                    data: {
                        coupencode,
                        datas,
                    },
                    method: 'post',
                    success: (response) => {
                        if (response.data) {
                            document.getElementById('totalcoupenamount').innerText = '$' + response.amountData;
                            document.getElementById('discountamountMinus').innerText = '-$' + response.coupenDis;
                            document.getElementById('placeholderValue').innerText = response.amountData;
                            document.getElementById('coupenid').value = response.coupenid;
                            document.getElementById('button-addon2').setAttribute('disabled', '');
                            const Toast = Swal.mixin({
                                toast: true,
                                position: "top-end",
                                showConfirmButton: false,
                                timer: 3000,
                                timerProgressBar: true,
                                didOpen: (toast) => {
                                    toast.onmouseenter = Swal.stopTimer;
                                    toast.onmouseleave = Swal.resumeTimer;
                                }
                            });
                            Toast.fire({
                                icon: "success",
                                title: "Coupen applied Successfully"
                            });

                        } else if (response.dataInvalid) {
                            Swal.fire("Invalid coupon code or expired!");
                        } else if (response.minAmount) {
                            Swal.fire("Minimum Cart Amount Needed!");
                        } else if (response.maxAmount) {
                            Swal.fire("Maximum Cart Amount Needed!");
                        } else {
                            Swal.fire("the coupen used!");
                        }
                    }
                })
            }
        </script>
</body>

</html>